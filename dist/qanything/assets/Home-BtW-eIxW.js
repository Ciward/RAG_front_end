import{u as Le,a as X,_ as lt,p as ae,O as ct}from"./OptionList-BQpYAzM2.js";import{g as ce,u as it}from"./index-CkCpcd0S.js";import{j as Z,o as d,B as v,d as s,C as _,D as t,E as ie,F as re,_ as G,k as S,b as h,G as b,H as N,n as T,S as D,f as Y,J,K as ge,L as j,M as Q,v as Te,x as rt,c as ne,g as E,N as R,w as $,T as ut,O as fe,Q as dt}from"./index-DcxLPFQQ.js";import{u as me,r as Oe,a as ht,C as pt}from"./utils-J6an4Bvk.js";import{u as vt,a as _t,b as ft,c as gt,_ as $e,D as mt,f as yt,h as bt,d as kt,e as wt,T as Ct}from"./HighLightMarkDown.vue_vue_type_style_index_0_lang-CpYx02yR.js";import{u as le,a as Dt,C as St,b as At}from"./ChatInfoPanel-D_e426-j.js";import{B as It}from"./index-Bc5vFfaj.js";import{_ as qt,a as xt}from"./ActionButton-D_5xI3Dh.js";import"./initDefaultProps-IXa-LX8E.js";import"./index-Clqg7D3E.js";import"./collapseMotion-6TYJj4gx.js";import"./class-DeKWk5pD.js";import"./index-D97v-wuH.js";import"./index-BriIEXVK.js";import"./index-DhFQVXxx.js";import"./LeftOutlined-DjCRyaFO.js";import"./RightOutlined-DQNGZT4k.js";import"./index-DngGwaeX.js";import"./injectionKey-DGYNie3Z.js";const Lt="/qanything/assets/icon-file-Bxz0aRpP.png",Ot=p=>(ie("data-v-870169ac"),p=p(),re(),p),$t={class:"upload-box"},Tt=Ot(()=>s("img",{class:"icon-file",src:Lt,alt:"图标"},null,-1)),Bt={class:"title"},Ft={class:"desc-content"},Et={class:"desc"},Rt={class:"desc"},Nt=Z({__name:"UploadDom",emits:["update"],setup(p,{emit:r}){const u=ce().home,g=r,k=()=>{g("update")};return(l,m)=>(d(),v("div",$t,[s("div",{class:"tips",onClick:k},[Tt,s("p",Bt,_(t(u).startDec),1),s("div",Ft,[s("p",Et,_(t(u).updesc2),1),s("p",Rt,_(t(u).require1),1)])])]))}}),Qt=G(Nt,[["__scopeId","data-v-870169ac"]]),jt=p=>(ie("data-v-387b8125"),p=p(),re(),p),Ut={class:"default"},Ht={class:"box"},Kt={class:"title"},zt=jt(()=>s("span",null," ",-1)),Pt={class:"color"},Mt={class:"desc"},Vt=Z({__name:"Defaultpage",setup(p){const r=ce().home,{setFileList:u}=Le(),{setModalVisible:g}=Le(),{setCurrentId:k,getList:l,setCurrentKbName:m}=X(),K=[".doc",".docx",".ppt",".pptx",".xls",".xlsx",".pdf",".md",".jpg",".jpeg",".png",".txt",".eml"],z=S(""),P=async()=>{console.log("updata");try{const C=await me.createKb({kb_name:r.defaultName});+C.code==200&&(z.value=C.data.kb_id,k(C.data.kb_id),m(C.kb_name),g(!0),l())}catch(C){u([]),b.error(C.msg)}};return(C,W)=>(d(),v("div",Ut,[s("div",Ht,[s("p",Kt,[s("span",null,_(t(r).homeTitle1),1),zt,s("span",Pt,_(t(r).homeTitle2),1)]),s("p",Mt,_(t(r).defaultDec),1),h(Qt,{"accept-list":K,onUpdate:P})])]))}}),Yt=G(Vt,[["__scopeId","data-v-387b8125"]]),Jt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAEgSURBVFiF7ZaxDcJADEVt0lAyQkaAKzIHI0BxkmeKCxiFAaKDDRAdJQvkQpNIEeQu9gVoyK8SXZz/ZPssA8ya9e/KYofW2nVRFMuqqh4pP5fEL0IHRJQj4tl7f7XW7hLMd734tRqgrutV94yIBw1Ea37o3rMsC2YgWALn3N0Yc0PEbQuxNcbcnHMXjXnTNPuyLE9qgBbiooEYMmfmY8wjCqCBSDEXAUggUs0BAFDyUachoxYoyVwNMATRl9YcQFiCvl7LMcUcIDIHfiV1BkIlkM6Jt7gp5p9oQnEGQldNO6ySAMbu+RSIUQDpkEmFGNsHVBMuBSLYhESUe++vUvMR8A0zD0KI9gFtZzPzsbshAPF9ICoiymPbzLfjZ836Dz0BusANDR+zFvgAAAAASUVORK5CYII=",Xt=p=>(ie("data-v-802f9f7a"),p=p(),re(),p),Zt={class:"history-chat"},Gt={class:"history-chat-content"},Wt={class:"list"},es=Xt(()=>s("div",{class:"line"},null,-1)),ts=["onClick"],ss=["onClick"],os=Z({__name:"HistoryChat",props:{observer:{type:Object,required:!0},observeDom:{type:Object,default:null},qaObserver:{type:Object,required:!0},qaObserveDom:{type:Object,default:null},showLoading:{type:Boolean,require:!0}},emits:["scrollBottom","setObserveDom","setQaObserverDom","clearHistory"],setup(p,{emit:r}){const u=p,{chatList:g,chatId:k,QA_List:l,qaPageId:m,pageId:K,historyList:z}=N(le()),{deleteHistoryList:P,getChatById:C}=le(),{setSelectList:W}=X(),x=r;function ue(w){l.value.push({question:w,type:"user"})}function U(w,A,i,y,I,B){l.value.push({answer:i,question:w,itemInfo:A,type:"ai",qaId:I,copied:!1,like:!1,unlike:!1,source:B||[],showTools:!0,picList:y})}async function de(w){if(!u.showLoading){k.value=w.historyId,l.value=[],m.value=1,W([...w.kbIds]),x("clearHistory");try{const A=C(k.value);u.qaObserveDom!==null&&(u.qaObserver.unobserve(u.qaObserveDom),x("setQaObserverDom",null)),A.list.forEach(i=>{i.type==="user"?ue(i.question):i.type==="ai"&&U(i.question,i.itemInfo,i.answer,i.picList,i.qaId,i.source)}),x("scrollBottom"),A.list.length>=50&&await Q(()=>{const i=document.getElementsByClassName("chat-li");i.length&&(u.qaObserver.observe(i[0]),x("setQaObserverDom",i[0]))})}catch(A){b.error(A.msg||"获取问答历史失败")}}}function M(){if(!u.showLoading){if(k.value===null){b.info("已切换最新对话");return}k.value=null,l.value=[],m.value=1,K.value=1,x("clearHistory")}}async function he(w,A){if(!u.showLoading)try{P(w.historyId),w.historyId===k.value&&M(),b.success("删除成功"),g.value.splice(A,1),await Q(()=>{ee()})}catch(i){b.error(i.msg||"删除失败")}}function ee(){if(u.qaObserveDom!==null){u.qaObserver.unobserve(u.qaObserveDom),x("setQaObserverDom",null);const w=document.getElementsByClassName("chat-li");w.length&&(u.qaObserver.observe(w[0]),x("setQaObserverDom",w[0]))}}return(w,A)=>(d(),v("div",Zt,[s("div",Gt,[s("div",Wt,[s("div",{class:T(["new-chat",[p.showLoading?"disabled":"",t(k)===null?"new-active":""]]),onClick:M},[h(D,{name:"new-chat"}),Y(" "+_(t(ce)().home.newConversation),1)],2),(d(!0),v(J,null,ge(t(z),(i,y)=>(d(),v("div",{key:i.historyId,class:T(["chat-item",t(k)===i.historyId?"item-active":"",p.showLoading?"disabled":""])},[es,s("span",{onClick:I=>de(i)},_(i.title),9,ts),t(k)===i.historyId?(d(),v("img",{key:0,src:Jt,class:"close-icon",alt:"close",onClick:I=>he(i,y)},null,8,ss)):j("",!0)],2))),128))])])]))}}),as=G(os,[["__scopeId","data-v-802f9f7a"]]),Be=p=>(ie("data-v-f94c5a36"),p=p(),re(),p),ns={class:"container showSider"},ls={class:"my-page"},cs={key:0,class:"user"},is=Be(()=>s("img",{class:"avatar",src:kt,alt:"头像"},null,-1)),rs={class:"question-text"},us={key:1,class:"ai"},ds=Be(()=>s("img",{class:"avatar",src:wt,alt:"头像"},null,-1)),hs={class:"ai-content"},ps={class:"ai-right"},vs={key:0},_s={key:1},fs={class:"source-list"},gs={class:"control"},ms={class:"tips"},ys=["href"],bs=["onClick"],ks={class:"source-content"},ws={class:"score"},Cs={class:"tips"},Ds={key:1,class:"feed-back"},Ss=["onClick"],As={class:"reload-text"},Is={class:"tools"},qs={key:0,class:"stop-btn"},xs={class:"question-box"},Ls={class:"question"},Os={class:"send-box"},$s={class:"send-action"},Ts=Z({__name:"Chat",setup(p){const r=ce().common,u=new Ct(e=>{e&&(l.value[l.value.length-1].answer+=e||"")}),{selectList:g,knowledgeBaseList:k}=N(X()),{QA_List:l,chatId:m,pageId:K,qaPageId:z,historyList:P}=N(le()),{chatSettingFormActive:C}=N(Dt()),{copy:W}=vt(),{addHistoryList:x,updateHistoryList:ue,addChatList:U,clearChatList:de}=le(),{setChatSourceVisible:M,setSourceType:he,setSourceUrl:ee,setTextContent:w}=_t(),{language:A}=N(it()),i=S(""),y=S(!1),I=S([]),B=S(null),te=S(null);let L;const Fe=S(null),ye=S(null),O=()=>{Q(()=>{Q(()=>{var e;(e=ye.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})})},be=new IntersectionObserver(e=>{e.forEach(o=>{o.isIntersecting&&(console.log("entry.isIntersecting"),K.value++)})}),ke=new IntersectionObserver(e=>{e.forEach(o=>{o.isIntersecting&&(console.log("qa entry.isIntersecting"),z.value++)})});Te(()=>{O()}),rt(()=>{B.value&&be.unobserve(B.value),te.value&&ke.unobserve(te.value)});const Ee=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?i.value+=`
`:pe(),e.preventDefault())},Re=ft((e,o)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){o.target.parentNode.style.animation="shake ease-in .5s";const a=setTimeout(()=>{clearTimeout(a),o.target.parentNode.style.animation=""},600)}},800),Ne=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Qe=e=>{W(e.answer).then(()=>{e.copied=!e.copied,b.success(r.copySuccess,1);const o=setTimeout(()=>{clearTimeout(o),e.copied=!e.copied},1e3)}).catch(()=>{b.error(r.copyFailed,1)})},je=e=>{l.value.push({question:e,type:"user"}),O()},we=e=>{l.value.push({answer:"",question:e,onlySearch:C.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},H=new pt,Ue=e=>{B.value=e},He=e=>{te.value=e},Ce=(e,o,a)=>{try{ue(e,o,a)}catch(n){b.error(n.msg||"更新对话失败")}};function Ke(){if(!g.value.length)return;const e=[];g.value.forEach(o=>{k.value.some(a=>a.kb_id===o)&&e.push(o)}),g.value=e,P.value.forEach(o=>{m.value!==null&&o.historyId===m.value&&o.kbIds.join("")!==g.value.join("")&&Ce(o.title,o.historyId,g.value)})}const ze=()=>{L&&L.abort("停止对话"),u.done(),y.value=!1,l.value[l.value.length-1].showTools=!0},Pe=e=>{try{if(m.value!==null)return;e.length>100&&(e=e.substring(0,100)),m.value=x(e),Ce(e,m.value,g.value)}catch(o){b.error(o.msg||"创建对话失败")}},pe=async()=>{if(!i.value.trim().length)return;if(y.value){b.warn("正在聊天中...请等待结束");return}if(!await et()){b.error("模型设置错误，请先检查模型配置");return}if(Ke(),g.value.length)b.info({content:r.type==="zh"?`已选择 ${g.value.length} 个知识库进行问答`:` ${g.value.length} knowledge base has been selected`,icon:" "});else return b.warning(r.chooseError);const e=i.value;Pe(e),i.value="",je(e),U(m.value,l.value),y.value=!0,L=new AbortController;const o={content:e};if(C.value.capabilities.onlySearch){H.addChatSetting(C.value),we(e);try{const a=await Oe(await me.sendQuestion(o,{signal:L.signal}));a.code===200&&(l.value[l.value.length-1].answer=a!=null&&a.source_documents.length?r.searchCompleted:r.searchNotFound,l.value[l.value.length-1].source=a==null?void 0:a.source_documents)}catch(a){console.log("出错",a),l.value[l.value.length-1].answer=a.msg||"error"}y.value=!1,l.value[l.value.length-1].showTools=!0,U(m.value,l.value),await Q(()=>{O()})}else yt(ht+"/stream/RAGFileChatStreamNoauth",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},body:JSON.stringify({content:e}),signal:L.signal,onopen(a){console.log("open",a),we(e),a.ok&&a.headers.get("content-type")==="text/event-stream"?(H.addChatSetting(C.value),u.start()):a.headers.get("content-type")==="application/json"&&u.add("Error 请检查模型是否配置正确")},onmessage(a){var F,c;console.log("message",a);const n=JSON.parse(a.data);if((n==null?void 0:n.code)==200&&(n!=null&&n.response)&&n.msg==="success")u.add(n==null?void 0:n.response),O();else{const q=n.time_record.time_usage;delete q.retriever_search_by_milvus,H.addTime(n.time_record.time_usage),H.addToken(n.time_record.token_usage),H.addDate(Date.now())}(F=n==null?void 0:n.source_documents)!=null&&F.length&&(l.value[l.value.length-1].source=n==null?void 0:n.source_documents),(c=n==null?void 0:n.show_images)!=null&&c.length&&(n==null||n.show_images.map(q=>{u.add(q),console.log(l.value.at(-1).answer)}))},onclose(a){console.log("close",a),u.done(),L.abort(),y.value=!1,l.value[l.value.length-1].showTools=!0,l.value.at(-1).itemInfo=H.getChatInfo(),U(m.value,l.value),Q(()=>{O()})},onerror(a){throw console.log("error",a),u==null||u.done(),L==null||L.abort(),y.value=!1,l.value[l.value.length-1].showTools=!0,b.error(a.msg||"出错了"),U(m.value,l.value),Q(()=>{O()}),a}})},Me=e=>{console.log("reAnswer"),i.value=e.question,pe()},Ve=(e,o)=>{e.source[o].showDetailDataSource=!e.source[o].showDetailDataSource},Ye=(e,o)=>{e.source[o].showDetailDataSource=!1},Je=e=>{I.value.push(e)},Xe=e=>{I.value=I.value.filter(o=>o!==e)},{showModal:ve}=N(gt()),_e=S(!1),se=S(""),V=S(""),Ze=()=>{y.value||(V.value="download",ve.value=!0,se.value=r.saveTip)},Ge=()=>{y.value||(V.value="delete",ve.value=!0,se.value=r.clearTip)},We=async()=>{if(_e.value=!0,V.value==="download"){console.log("download");try{const e=document.getElementById("chat-ul"),a=(await bt(e,{useCORS:!0})).toDataURL("image/png"),n=document.createElement("a");n.style.display="none",n.href=a,n.setAttribute("download","chat-shot.png"),typeof n.download>"u"&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(a),b.success("下载成功"),Promise.resolve()}catch(e){console.log(e),b.error(e.message||e.msg||"出错了")}}else V.value==="delete"&&(console.log("delete"),de(m.value),m.value=null,l.value=[]);V.value="",se.value="",_e.value=!1,ve.value=!1},De=S(),et=()=>De.value.handleOk();let Se=["pdf","docx","xlsx","txt","md","jpg","png","jpeg","csv","eml"];const Ae=e=>{if(!e)return!1;const o=e.split(".");if(o.length){const a=o.pop();return!!Se.includes(a)}else return!1},tt=e=>{console.log("handleChatSource",e),Ae(e.file_name)&&st(e)};async function st(e){try{ee(null);const o=await Oe(await me.getFile({file_id:e.file_id}));console.log("queryFile",o);const a=e.file_name.split(".").pop(),n=at(a);if(console.log("b64Type",n),he(a),ee(`data:${n};base64,${o.file_base64}`),a==="txt"||a==="md"||a==="csv"||a==="eml"){const F=atob(o.file_base64),c=decodeURIComponent(escape(F));console.log("decodedTxt",c),w(c),M(!0)}else M(!0)}catch(o){b.error(o.msg||"获取文件失败")}}let ot=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg","text/csv","message/rfc822","application/vnd.openxmlformats-officedocument.presentationml.presentation"];function at(e){const o=Se.indexOf(e);return ot[o]}function nt(){console.log("清空")}return(e,o)=>{const a=It,n=qt,F=xt;return d(),v(J,null,[h(as,{observer:t(be),"observe-dom":t(B),"qa-observe-dom":t(te),"qa-observer":t(ke),"show-loading":t(y),onScrollBottom:O,onSetObserveDom:Ue,onSetQaObserverDom:He,onClearHistory:nt},null,8,["observer","observe-dom","qa-observe-dom","qa-observer","show-loading"]),s("div",ns,[s("div",ls,[s("div",{id:"chat",ref_key:"chatContainer",ref:Fe,class:"chat showSider"},[s("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ye},[(d(!0),v(J,null,ge(t(l),(c,q)=>{var Ie,qe;return d(),v("li",{key:q},[c.type==="user"?(d(),v("div",cs,[is,s("p",rs,_(c.question),1)])):(d(),v("div",us,[ds,s("div",hs,[s("div",ps,[s("p",{class:T(["question-text",[!c.source.length&&!((Ie=c==null?void 0:c.picList)!=null&&Ie.length)?"change-radius":"",c.showTools?"":"flashing"]])},[h($e,{content:c.answer.toString()},null,8,["content"]),Object.keys(((qe=c==null?void 0:c.itemInfo)==null?void 0:qe.tokenInfo)||{}).length?(d(),ne(St,{key:0,"chat-item-info":c.itemInfo},null,8,["chat-item-info"])):j("",!0)],2),c.source.length?(d(),v(J,{key:0},[s("div",{class:T(["source-total",t(I).includes(q)?"":"source-total-last"])},[t(A)==="zh"?(d(),v("span",vs," 找到了"+_(c.source.length)+"个信息来源： ",1)):(d(),v("span",_s," Found "+_(c.source.length)+" source of information ",1)),E(h(D,{name:"down",onClick:f=>Je(q)},null,8,["onClick"]),[[R,!t(I).includes(q)]]),E(h(D,{name:"up",onClick:f=>Xe(q)},null,8,["onClick"]),[[R,t(I).includes(q)]])],2),E(s("div",fs,[(d(!0),v(J,null,ge(c.source,(f,oe)=>(d(),v("div",{key:oe,class:"data-source"},[E(s("p",gs,[s("span",ms,_(t(r).dataSource)+_(oe+1)+":",1),f.file_url.startsWith("http")?(d(),v("a",{key:0,href:f.file_url,target:"_blank"},_(f.file_name),9,ys)):(d(),v("span",{key:1,class:T(["file",Ae(f.file_name)?"filename-active":""]),onClick:xe=>tt(f)},_(f.file_name),11,bs)),E(h(D,{name:"iconup",onClick:xe=>Ye(c,oe)},null,8,["onClick"]),[[R,f.showDetailDataSource]]),E(h(D,{name:"icondown",onClick:xe=>Ve(c,oe)},null,8,["onClick"]),[[R,!f.showDetailDataSource]])],512),[[R,f.file_name]]),h(ut,{name:"sourceitem"},{default:$(()=>[E(s("div",ks,[h($e,{content:f.content},null,8,["content"]),s("p",ws,[s("span",Cs,_(t(r).correlation),1),Y(" "+_(f.score),1)])],512),[[R,f.showDetailDataSource]])]),_:2},1024)]))),128))],512),[[R,t(I).includes(q)]])],64)):j("",!0),c.showTools?(d(),v("div",Ds,[s("div",{class:"reload-box",onClick:f=>Me(c)},[h(D,{name:"reload"}),s("span",As,_(t(r).regenerate),1)],8,Ss),s("div",Is,[h(D,{style:fe({color:c.copied?"#4D71FF":""}),name:"copy",onClick:f=>Qe(c)},null,8,["style","onClick"]),h(D,{style:fe({color:c.like?"#4D71FF":""}),name:"like",onClick:f=>t(Re)(c,f)},null,8,["style","onClick"]),h(D,{style:fe({color:c.unlike?"#4D71FF":""}),name:"unlike",onClick:f=>Ne(c)},null,8,["style","onClick"])])])):j("",!0)])])]))])}),128))],512)],512),t(y)?(d(),v("div",qs,[h(a,{onClick:ze},{icon:$(()=>[h(D,{name:"stop",class:T(t(y)?"loading":"")},null,8,["class"])]),default:$(()=>[Y(" "+_(t(r).stop),1)]),_:1})])):j("",!0),s("div",xs,[s("div",Ls,[s("div",Os,[h(n,{value:t(i),"onUpdate:value":o[0]||(o[0]=c=>dt(i)?i.value=c:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:t(r).problemPlaceholder,"auto-size":{minRows:1,maxRows:8},onKeydown:Ee},null,8,["value","placeholder"]),s("div",$s,[h(F,{placement:"topLeft"},{content:$(()=>[Y(_(t(r).chatToPic),1)]),default:$(()=>[s("span",{class:T(["download",t(y)?"isPreventClick":""]),onClick:Ze},[h(D,{name:"chat-download"})],2)]),_:1}),h(F,null,{content:$(()=>[Y(_(t(r).clearChat),1)]),default:$(()=>[s("span",{class:T(["delete",t(y)?"isPreventClick":""]),onClick:Ge},[h(D,{name:"chat-delete"})],2)]),_:1}),h(a,{type:"primary",disabled:t(y),shape:"circle",onClick:pe},{default:$(()=>[h(D,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]),s("div",{class:"scroll-btn-div"},[s("img",{class:"avatar",src:lt,alt:"滑到底部",onClick:O})])]),h(At,{ref_key:"chatSettingForDialogRef",ref:De},null,512),h(mt,{content:t(se),"confirm-loading":t(_e),onOk:We},null,8,["content","confirm-loading"])],64)}}}),Bs=G(Ts,[["__scopeId","data-v-f94c5a36"]]),Fs={class:"page"},Es={class:"container"},Rs={key:0,class:"initing"},Ns=Z({__name:"Home",setup(p){const{showDefault:r}=N(X()),{setDefault:u,getList:g}=X(),k=l=>{u(l),g()};return Te(()=>{g()}),(l,m)=>(d(),v("div",Fs,[s("div",Es,[t(r)===t(ae).initing?(d(),v("div",Rs)):j("",!0),t(r)===t(ae).default?(d(),ne(Yt,{key:1,onChange:k})):t(r)===t(ae).normal?(d(),ne(Bs,{key:2})):t(r)===t(ae).optionlist?(d(),ne(ct,{key:3})):j("",!0)])]))}}),ao=G(Ns,[["__scopeId","data-v-99cfc3d2"]]);export{ao as default};
