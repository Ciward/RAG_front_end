import{_ as Se}from"./bot-avatar-CBCRm2Zm.js";import{u as pe}from"./useBots-BMzSGxSW.js";import{r as $,u as ee,b as ze,a as Qe,C as Me}from"./utils-J6an4Bvk.js";import{g as he,u as Ge}from"./index-CkCpcd0S.js";import{a as Be,c as je,b as Je,C as $e}from"./ChatInfoPanel-D_e426-j.js";import{u as ge}from"./useBotsChat-DZcCwBZl.js";import{j as ve,H as V,k,l as Ie,v as et,o as c,B as r,d as t,b as l,D as s,Q as te,C as u,n as P,f as O,J as W,K as oe,w as K,G as w,E as xe,F as Fe,_ as Ae,g as L,N as T,S as B,L as E,e as tt,M as ue,c as Ce,T as ot,O as de}from"./index-DcxLPFQQ.js";import{I as De,_ as st}from"./ActionButton-D_5xI3Dh.js";import{B as Le}from"./index-Bc5vFfaj.js";import{u as at,a as nt,b as lt,c as ct,D as it,h as rt,_ as ut,e as Te,d as dt,T as pt,f as ht,I as gt}from"./HighLightMarkDown.vue_vue_type_style_index_0_lang-CpYx02yR.js";import{_ as vt}from"./lock-DmQwPPsI.js";import"./index-Clqg7D3E.js";import"./collapseMotion-6TYJj4gx.js";import"./class-DeKWk5pD.js";import"./initDefaultProps-IXa-LX8E.js";import"./LeftOutlined-DjCRyaFO.js";import"./RightOutlined-DQNGZT4k.js";const At="data:image/png;base64,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",_t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAQBSURBVFiF1Zk/aBtnFMB/73TWUJwUi0CoS4KHxEPw4n+0aQMpGWwPLaQYeywt0l0OFxwC7ZohawuhHoR9Z2jwaFEayFDbgyGQ4BaEp5DBWURCFZoauSTOoujuZdB3RpKNY8e25P4m6b67e7+7033fe0/C+yGO41wErgADItINdAInzPgroKiqa0AeWA6CYAXQfQfaz86u655V1QkR+Qb4aJ+xnqvqnIhkfd9/eqiCmUzmdCKRuKmqDtBmNj8BFkXkgao+LpfLz7q6ul4CFAqFk8lk8oyIXFDVS8AwcN4c90ZEgjAMb83Ozv5zYEHHcb4VkZ+AU0AFmAemfN//ay8XF+O67ifAJDAO2MC6qv4YBMGd9xIcGxtLplKp26o6YTYtqOr1IAjW9iPWiOM43SLyCzACICLZUql0I5fLlfcsODEx0V6pVH4DhoBN4Aff92cOItaI67rXgJ+BdmDJtu3RbDa7+U7BsbGxZEdHxz1gSFWLiURieHp6+tFhysV4ntcThuGiiHQCSxsbG1813kmr8aBUKnU7loui6PJRyQFMT08/iqLosqoWgSETu466O2heiF+BTcuyLh6lXC2e5/VEUbQCtKvqd7UvTiL+kMlkTluWdRf4AJicmZn5oxlyAPl8/kV/f38J+FJELvX29s6trq6+hppHnEgkblKdShYO+4XYCybmAnDKuLAlaFYIB6io6vVmy8WY2BVVdVzXPbslaOa6NmD+oPPcQTCx54G2eP61ADFrK8BUq+RqmAIwTiKO43wmIg+BJ77vd7fWrYrrumvAeVX93KKaMgEsttCpkdjligUMAIjIg9b51FPjMmCZZBNVfdxCpzpiFxHptqhmwpTL5WcttaqhxqXTxqTpcbK5G67r/g5cPWD8u77vf73bDl1dXS+LxSLAiW3JwnHDplrgfFgoFE4C/+2287uu/LAwJQPAKwsoAiSTyTPNCL4XalyKlikNEZELLXSqI3ZR1TWLat2Kqb6OBTUueQtYNl+GW+SzE7HLsgDiuu7fVAvxT/dbTh42pjz9E3ju+/7HFqCqOmfGJ1untsUkgHFSC6q1KfAGGHccp2UZjYk9TrX7kAWTsPq+/1REAsA2RXVLMLFtEQni/s3WShKG4S1gHRgxRXVTMTFHgHXjAtRUdaurq6/7+vr+FZGrwBeDg4P38vn8i2bIeZ7Xo6rzQFJVv5+dnX0Yj9WtxUEQ3DHPvj0Mw8V0On3uqOXS6fS5MAwXgXYRyTY2k7YlC6VS6QawJCKdlmXd9zyv56jkPM/rsSzrftz6MLHr2CaYy+XKtm2PxpJRFK0cxW/Sdd1rURStxHK2bY/u1OH6f7bfGk54PBuYtRzrFnAtx7aJvtNxzfob4i2ESvnrjyWOcQAAAABJRU5ErkJggg==",ft="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAOBSURBVFiFzZixdeJAEIb/WZAiAjqADiiBwAUQOHOg97BlhQQUQEABBIRCZ7+ngMwBBThQARfQgegAv4cTOHYuuFksQBJIYM5/AojVzqcZ7ezsEDNX8IOl/jfAKVUvuTkMw/p6vW4TUUNrXWfmBgAQ0UIptWTmhW3bkeM4y7I2qGiIwzCsbzYbZ7vddoioxcz1k0aIZkQ0c103/FZA3/d7RDQwUES0ZOY5gDkRLYkoBgBmbsqYFoB2YopYKTUsAnoW4Ovra2uz2bwBaMqlSCk1Pid85jXQWvcSsHGtVrt7eHhYXAwYBIHDzCPxSCQeiE5NnDWX1noAoCkef3Jdd1YacDKZDJh5ID/Hnuf1y4Adyvf9EYAeABDR8Pn5eVgYMAiCjtb6TX72Pc8bXwPOKPnwSqnHrPcyFXA6nTY+Pz9/M3P91BNeIt/3ewBGRLSsVqt33W53fjgmNVGvVqt3eefG3wUHABKVMTPXZREe6QgwCAIH/1ZrfK13Lk9iIwLQFI/mA8oqg1KqsOeCIHDSjJySsUVEgzAM9xL/HmDCe1GZrK+1fgEwKnqfpK1IQu1kAjJzBwCUUlddsefI2Nxut5296+ZLGIZ1A2jbdqlEfIls244kebeSYd4Brtdrsw1dVH2UleM4S2aeM3M9wfIFSEQN+XqUi26o+QHLF6DWeleh3J7rn4xtwwIkCtZEsRnnTSIb/kveGN/3/2T8lbtlElHMzDsWoETJn3y6olJKFY7OzoNEtBD6Zt4NZntK+894zvO8UkcJY5uIdnVicpHEMqi0hy6VsZ30dDLEH/LZuiXUgVoAwMzHHsxKlLeS2GwbliPArER5KxmbRDRLbhR7q7hSqcwAQA44N5WxSUR7Z5Q9QMuyQkmW7SAIynixr5R6LHqTVFFtAPFhFbUHKGEeAl91YRF5njcuWaZl1qBHiVryXAygLaevb5XYaCLFe6mAAGBZ1r2EulemQj5Xk8lkAKBHRMtarXaXNiYVsNvtzonInEdGMtFV5ft+zxw7iegpq8uQuRe7rhsS0RAAmHlwzXDLXCOBG+Z1F85pfXSY+ZdsQ4WbPwdztWVBtGVT6J+a66zm0XQ6baxWq3dcsXlkWdZ92kG9FKBRsvmTuBwhp/2W7CFKu25YpI1SuIFpQJm5Yw5ZuQakh1ipVGaWZYVFzzulAI3yWsDizY+bt4BvrR/f5f8LxA8rSSHVBD4AAAAASUVORK5CYII=",se=v=>(xe("data-v-e435d805"),v=v(),Fe(),v),mt={class:"bot-detail-edit-comp"},kt={class:"name-avatar"},wt=se(()=>t("img",{src:Se,alt:"avatar"},null,-1)),bt={class:"title"},yt={class:"title"},Ct={class:"title"},St=se(()=>t("span",null,"*",-1)),Bt=se(()=>t("img",{class:"knowledge-icon",src:At,alt:"knowledge"},null,-1)),It={class:"kb-name"},xt=["onClick"],Ft=se(()=>t("img",{class:"add-knowedge",src:ft,alt:"icon"},null,-1)),Dt={class:"save"},Lt={class:"title"},Tt={class:"chat-setting-form-footer"},Rt=ve({__name:"BotDetailEdit",setup(v){const{curBot:m,knowledgeList:b}=V(pe()),{QA_List:N}=V(ge()),{setSelectKnowledgeVisible:U,setCurBot:g}=pe(),{setChatSettingConfigured:h}=Be(),{bots:y,common:Z}=he(),q=k(""),F=k(""),H=k(""),X=Ie(()=>F.value.match(/[^a-zA-Z\s]|\p{P}|\w+/g));et(()=>{console.log("curBot",m.value),q.value=m.value.bot_name,H.value=m.value.welcome_message,F.value=m.value.prompt_setting});const C=async A=>{try{const p=await $(await ee.queryBotInfo({bot_id:A}));console.log("getBotInfo",p),g(p[0])}catch(p){w.error(p.msg||"获取Bot信息失败")}},ae=async()=>{try{await $(await ee.updateBot({bot_id:m.value.bot_id,bot_name:q.value,prompt_setting:F.value,welcome_message:H.value})),C(m.value.bot_id),w.success(y.saveSuccessful)}catch(A){console.log("error--",A),w.error(A.msg||"保存失败，请重试")}},I=async A=>{let p=m.value.kb_ids;console.log("removeKb",A,p),p=p.filter(_=>_!=A);try{await $(await ee.updateBot({bot_id:m.value.bot_id,kb_ids:p})),C(m.value.bot_id),b.value=b.value.map(_=>(_.kb_id===A&&(_.state=_.state===0?1:0),_)),w.success(y.removalSucessful)}catch(_){w.error(_.msg||"请求失败")}},x=k(""),R=async()=>{const A=await x.value.onCheck();Object.hasOwn(A,"errorFields")||(h(A),w.success("应用成功"))};return(A,p)=>{const _=De,G=st,j=Le;return c(),r("div",mt,[t("div",kt,[wt,l(_,{value:s(q),"onUpdate:value":p[0]||(p[0]=S=>te(q)?q.value=S:null),placeholder:s(y).inputBotName,"show-count":"",maxlength:20},null,8,["value","placeholder"])]),t("div",bt,u(s(y).roleSetting),1),l(G,{value:s(F),"onUpdate:value":p[1]||(p[1]=S=>te(F)?F.value=S:null),class:"role-setting-input","auto-size":{minRows:7,maxRows:7},rows:7},null,8,["value"]),t("div",{class:P(["role-setting-length",s(X)&&s(X).length>2e3?"over-length":""])},u(s(X)?s(X).length:0)+" / 2000 ",3),t("div",yt,u(s(y).welcomeMessage),1),l(G,{value:s(H),"onUpdate:value":p[2]||(p[2]=S=>te(H)?H.value=S:null),class:"greeting-input","show-count":"",maxlength:100,placeholder:s(y).inputWelcomMsg,"auto-size":{minRows:6,maxRows:6},rows:6},null,8,["value","placeholder"]),t("div",Ct,[O(u(s(y).associatedKb),1),St]),(c(!0),r(W,null,oe(s(m).kb_ids,(S,ne)=>(c(),r("div",{key:S,class:"knowedge-item knowledge-info"},[Bt,t("div",It,u(s(m).kb_names[ne]),1),t("img",{class:"remove-icon",src:_t,alt:"remove",onClick:le=>I(S)},null,8,xt)]))),128)),t("div",{class:"knowedge-item add-knowledge-content",onClick:p[3]||(p[3]=S=>s(U)(!0))},[Ft,O(" "+u(s(y).clickAssociatedKb),1)]),t("div",Dt,[l(j,{class:"save-btn",type:"primary",onClick:ae},{default:K(()=>[O(u(s(y).save),1)]),_:1})]),t("div",Lt,u(s(Z).modelSettingTitle),1),l(je,{ref_key:"chatSettingFormRef",ref:x,"context-length":s(N).length},null,8,["context-length"]),t("div",Tt,[l(j,{type:"primary",style:{width:"auto"},onClick:R},{default:K(()=>[O(u(s(Z).confirmApplication),1)]),_:1})])])}}}),Ut=Ae(Rt,[["__scopeId","data-v-e435d805"]]),M=v=>(xe("data-v-cd4fef6b"),v=v(),Fe(),v),qt={class:"bots-chat-container"},Ht={class:"my-page"},Yt={class:"header"},Et=M(()=>t("img",{src:Se,alt:"avatar"},null,-1)),Kt={id:"chat",class:"chat"},Vt={class:"ai"},Ot={class:"content"},Xt=M(()=>t("img",{class:"avatar",src:Te,alt:"头像"},null,-1)),Pt=["innerHTML"],Wt={key:0,class:"user"},Nt=M(()=>t("img",{class:"avatar",src:dt,alt:"头像"},null,-1)),Zt={class:"question-text"},zt={key:1,class:"ai"},Qt={class:"content"},Mt=M(()=>t("img",{class:"avatar",src:Te,alt:"头像"},null,-1)),Gt={key:1},jt={key:0},Jt={key:1},$t={class:"source-list"},eo={class:"control"},to={class:"tips"},oo=["href"],so=["onClick"],ao={class:"source-content"},no=["innerHTML"],lo={class:"score"},co={class:"tips"},io={key:2,class:"feed-back"},ro=["onClick"],uo={class:"reload-text"},po={class:"tools"},ho={class:"stop-placeholder"},go={class:"question-box"},vo={class:"question"},Ao={class:"send-plane"},_o={key:0,class:"mask"},fo=M(()=>t("img",{src:vt,alt:"icon"},null,-1)),mo=ve({__name:"Chat",props:{chatType:{type:String,default:"edit"},botInfo:{type:Object,default:()=>{}}},setup(v){const m=v,b=he().common,N=he().bots,U=new pt(e=>{e&&(g.value[g.value.length-1].answer+=e||"")}),{QA_List:g}=V(ge()),{chatSettingFormActive:h}=V(Be()),{copy:y}=at(),{setChatSourceVisible:Z,setSourceType:q,setSourceUrl:F,setTextContent:H}=nt(),{language:X}=V(Ge()),C=k(""),ae=Ie(()=>{const e=h.value.context;if(e===0)return[];const a=g.value.filter(n=>n.type==="ai");return(e===11?a:a.slice(-e)).map(n=>[n.question,n.answer])}),I=k(!1),x=k([]);let R;const A=k(null),p=k(null),_=()=>{ue(()=>{var e;(e=A.value)==null||e.scrollIntoView(!1)})},G=lt((e,a)=>{if(e.like=!e.like,e.unlike=!1,e.like){a.target.parentNode.style.animation="shake ease-in .5s";const f=setTimeout(()=>{clearTimeout(f),a.target.parentNode.style.animation=""},600)}},800),j=e=>{e.unlike=!e.unlike,e.like=!1},S=e=>{y(e.answer).then(()=>{e.copied=!e.copied,w.success(b.copySuccess,1);const a=setTimeout(()=>{clearTimeout(a),e.copied=!e.copied},1e3)}).catch(()=>{w.error(b.copyFailed,1)})},ne=e=>{g.value.push({question:e,type:"user"}),_()},le=e=>{g.value.push({answer:"",question:e,onlySearch:h.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],picList:null,showTools:!1})},z=new Me,Re=()=>{R&&R.abort(),U.done(),I.value=!1,g.value[g.value.length-1].showTools=!0},ce=async()=>{var f;if(!C.value.trim().length)return;if(!C.value.length){w.warn("正在聊天中...请等待结束");return}if(!await Xe()){w.error("模型设置错误，请先检查模型配置");return}const e=C.value;C.value="",ne(e),I.value=!0,(f=A.value)==null||f.scrollIntoView(!0),R=new AbortController;const a={"Content-Type":"application/json",Accept:["text/event-stream","application/json"],"Transfer-Encoding":"chunked",Connection:"keep-alive"};ht(Qe+"/local_doc_qa/local_doc_chat",{method:"POST",headers:a,openWhenHidden:!0,body:JSON.stringify({user_id:ze,bot_id:m.botInfo.bot_id,history:ae.value,question:e,streaming:h.value.capabilities.onlySearch===!1,networking:h.value.capabilities.networkSearch,product_source:"saas",rerank:h.value.capabilities.rerank,only_need_search_results:h.value.capabilities.onlySearch,hybrid_search:h.value.capabilities.mixedSearch,max_token:h.value.maxToken,api_base:h.value.apiBase,api_key:h.value.apiKey,model:h.value.apiModelName,api_context_length:h.value.apiContextLength,chunk_size:h.value.chunkSize,top_p:h.value.top_P,top_k:h.value.top_K,temperature:h.value.temperature}),signal:R.signal,onopen(n){console.log("open"),z.addChatSetting(h.value),n.ok&&n.headers.get("content-type")==="text/event-stream"?(console.log("everything's good"),le(e),U.start()):n.headers.get("content-type")==="application/json"&&le(e)},onmessage(n){var o;console.log("message");const i=JSON.parse(n.data);if(console.log(i),(i==null?void 0:i.code)==200&&(i!=null&&i.response)&&i.msg==="success")U.add(i==null?void 0:i.response.replaceAll(`
`,"<br/>")),_();else{const D=i.time_record.time_usage;delete D.retriever_search_by_milvus,z.addTime(i.time_record.time_usage),z.addToken(i.time_record.token_usage),z.addDate(Date.now())}(o=i==null?void 0:i.source_documents)!=null&&o.length&&(g.value[g.value.length-1].source=i==null?void 0:i.source_documents)},onclose(n){console.log("close",n),U.done(),R.abort(),I.value=!1,g.value[g.value.length-1].showTools=!0,g.value.at(-1).itemInfo=z.getChatInfo(),ue(()=>{_()})},onerror(n){throw console.log("error",n),U.done(),R.abort(),I.value=!1,g.value[g.value.length-1].showTools=!0,ue(()=>{_()}),n}})},Ue=e=>{console.log("reAnswer"),C.value=e.question,ce()},qe=(e,a)=>{e.source[a].showDetailDataSource=!1},He=(e,a)=>{e.source[a].showDetailDataSource=!e.source[a].showDetailDataSource},Ye=e=>{x.value.push(e)},Ee=e=>{x.value=x.value.filter(a=>a!==e)},{showModal:_e}=V(ct()),{clearQAList:Ke}=ge(),ie=k(!1),re=k(""),J=k(""),Ve=()=>{J.value="download",_e.value=!0,re.value=b.saveTip},Oe=async()=>{if(ie.value=!0,J.value==="download"){console.log("download");try{const e=document.getElementById("chat-ul"),f=(await rt(e,{useCORS:!0})).toDataURL("image/png"),n=document.createElement("a");n.style.display="none",n.href=f,n.setAttribute("download","chat-shot.png"),typeof n.download>"u"&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(f),w.success(N.downloadSuccessful),Promise.resolve()}catch(e){console.log(e),w.error(e.message||e.msg||"出错了")}}else J.value==="delete"&&(console.log("delete"),Ke());J.value="",re.value="",ie.value=!1,_e.value=!1},fe=k(),Xe=()=>fe.value.handleOk();let me=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const ke=e=>{if(!e)return!1;const a=e.split(".");if(a.length){const f=a.pop();return!!me.includes(f)}else return!1},Pe=e=>{console.log("handleChatSource",e),ke(e.file_name)&&We(e)};async function We(e){try{F(null);const a=await $(await ee.getFile({file_id:e.file_id}));console.log("queryFile",a);const f=e.file_name.split(".").pop(),n=Ze(f);if(console.log("b64Type",n),q(f),F(`data:${n};base64,${a.base64_content}`),f==="txt"){const i=atob(a.base64_content),o=decodeURIComponent(escape(i));console.log("decodedTxt",o),H(o),Z(!0)}else Z(!0)}catch(a){w.error(a.msg||"获取文件失败")}}let Ne=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function Ze(e){const a=me.indexOf(e);return Ne[a]}return _(),(e,a)=>{const f=gt,n=Le,i=De;return c(),r(W,null,[t("div",qt,[t("div",Ht,[t("div",Yt,[Et,O(" "+u(v.botInfo.bot_name),1)]),t("div",Kt,[t("ul",{id:"chat-ul",ref_key:"scrollDom",ref:A},[t("div",Vt,[t("div",Ot,[Xt,t("p",{class:"question-text",innerHTML:v.botInfo.welcome_message},null,8,Pt)])]),(c(!0),r(W,null,oe(s(g),(o,D)=>{var we,be,ye;return c(),r("li",{key:D},[o.type==="user"?(c(),r("div",Wt,[Nt,t("p",Zt,u(o.question),1)])):(c(),r("div",zt,[t("div",Qt,[Mt,o.onlySearch?E("",!0):(c(),r("p",{key:0,class:P(["question-text",[!o.source.length&&!((we=o==null?void 0:o.picList)!=null&&we.length)?"change-radius":"",o.showTools?"":"flashing"]])},[o.answer?(c(),Ce(ut,{key:0,content:o.answer},null,8,["content"])):(c(),r("span",Gt,u(o.answer),1)),Object.keys(((be=o==null?void 0:o.itemInfo)==null?void 0:be.tokenInfo)||{}).length?(c(),Ce($e,{key:2,"chat-item-info":o.itemInfo},null,8,["chat-item-info"])):E("",!0)],2))]),(ye=o==null?void 0:o.picList)!=null&&ye.length?(c(!0),r(W,{key:0},oe(o.picList,(d,Y)=>(c(),r("div",{key:d+Y,class:P(["data-picList",!o.source.length&&Y+1===o.picList.length?"picList-radius":""])},[l(f,{width:150,src:d,class:"responsive-image"},null,8,["src"])],2))),128)):E("",!0),o.source.length?(c(),r(W,{key:1},[t("div",{class:P(["source-total",s(x).includes(D)?"":"source-total-last"])},[s(X)==="zh"?(c(),r("span",jt,"找到了"+u(o.source.length)+"个信息来源：",1)):(c(),r("span",Jt,"Found "+u(o.source.length)+" source of information",1)),L(l(B,{name:"down",onClick:d=>Ye(D)},null,8,["onClick"]),[[T,!s(x).includes(D)]]),L(l(B,{name:"up",onClick:d=>Ee(D)},null,8,["onClick"]),[[T,s(x).includes(D)]])],2),L(t("div",$t,[(c(!0),r(W,null,oe(o.source,(d,Y)=>(c(),r("div",{key:Y,class:"data-source"},[L(t("p",eo,[t("span",to,u(s(b).dataSource)+u(Y+1)+":",1),d.file_id.startsWith("http")?(c(),r("a",{key:0,href:d.file_id,target:"_blank"},u(d.file_name),9,oo)):(c(),r("span",{key:1,class:P(["file",ke(d.file_name)?"filename-active":""]),onClick:Q=>Pe(d)},u(d.file_name),11,so)),L(l(B,{name:"iconup",onClick:Q=>qe(o,Y)},null,8,["onClick"]),[[T,d.showDetailDataSource]]),L(l(B,{name:"icondown",onClick:Q=>He(o,Y)},null,8,["onClick"]),[[T,!d.showDetailDataSource]])],512),[[T,d.file_name]]),l(ot,{name:"sourceitem"},{default:K(()=>{var Q;return[L(t("div",ao,[t("p",{innerHTML:(Q=d.content)==null?void 0:Q.replaceAll(`
`,"<br/>")},null,8,no),t("p",lo,[t("span",co,u(s(b).correlation),1),O(u(d.score),1)])],512),[[T,d.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[T,s(x).includes(D)]])],64)):E("",!0),o.showTools?(c(),r("div",io,[t("div",{class:"reload-box",onClick:d=>Ue(o)},[l(B,{name:"reload"}),t("span",uo,u(s(b).regenerate),1)],8,ro),t("div",po,[l(B,{style:de({color:o.copied?"#4D71FF":""}),name:"copy",onClick:d=>S(o)},null,8,["style","onClick"]),l(B,{style:de({color:o.like?"#4D71FF":""}),name:"like",onClick:d=>s(G)(o,d)},null,8,["style","onClick"]),l(B,{style:de({color:o.unlike?"#4D71FF":""}),name:"unlike",onClick:d=>j(o)},null,8,["style","onClick"])])])):E("",!0)]))])}),128)),L(t("div",ho,null,512),[[T,s(I)]]),L(t("div",{ref_key:"stopBtn",ref:p,class:"stop-btn"},[l(n,{onClick:Re},{icon:K(()=>[l(B,{name:"stop",class:P(s(I)?"loading":"")},null,8,["class"])]),default:K(()=>[O(" "+u(s(b).stop),1)]),_:1})],512),[[T,s(I)]])],512)]),t("div",go,[t("div",vo,[v.chatType==="share"?(c(),r("span",{key:0,class:"download",onClick:Ve},[l(B,{name:"chat-download"})])):E("",!0),l(i,{value:s(C),"onUpdate:value":a[0]||(a[0]=o=>te(C)?C.value=o:null),"max-length":"200",placeholder:s(b).problemPlaceholder,onKeyup:tt(ce,["enter"])},{suffix:K(()=>[t("div",Ao,[l(n,{type:"primary",disabled:s(I),onClick:ce},{default:K(()=>[l(B,{name:"sendplane"})]),_:1},8,["disabled"])])]),_:1},8,["value","placeholder"])])])]),!v.botInfo.kb_ids||!v.botInfo.kb_ids.length?(c(),r("div",_o,[fo,t("p",null,u(s(N).bindKbtoPreview),1)])):E("",!0),l(Je,{ref_key:"chatSettingForDialogRef",ref:fe},null,512)]),l(it,{content:s(re),"confirm-loading":s(ie),onOk:Oe},null,8,["content","confirm-loading"])],64)}}}),ko=Ae(mo,[["__scopeId","data-v-cd4fef6b"]]),wo={class:"edit-detail"},bo={class:"bots-chat-page"},yo=ve({__name:"EditDetail",setup(v){const{curBot:m}=V(pe());return(b,N)=>(c(),r("div",wo,[l(Ut),t("div",bo,[l(ko,{"bot-info":s(m),"chat-type":"edit"},null,8,["bot-info"])])]))}}),Oo=Ae(yo,[["__scopeId","data-v-27fa0036"]]);export{Oo as default};
